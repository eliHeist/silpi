{% extends 'base.html' %} {% load static %}

{% block content %}
<main class="pb-20 pt-40" x-data="$store.cart">
    <div class="container mx-auto p-4 bg-white rounded-lg shadow-lg flex">
        <!-- Product Image (Left) -->
        <div class="w-1/2">
            <img src="{{ product.thumbnail.url }}" alt="Product" class="w-full h-auto">
        </div>

        <!-- Product Details (Right) -->
        <div class="w-1/2 p-6">
            <h2 class="text-2xl font-semibold mb-4">{{ product.name }}</h2>
            <p class="text-gray-700 mb-4">{{ product.details }}</p>
            <p class="text-gray-800 font-semibold text-xl mb-4">
                {% if product.price %}
                {{ product.price }}
                {% else %}
                Unset
                {% endif %}
            </p>

            <div id="token" class="hidden">{% csrf_token %}</div>

            <!-- Add to Cart Button -->
            <div class="grid gap-2">
                <div class="grid grid-flow-col items-center gap-8">
                    <label class="font-semibold">Quantity</label>
                    <input type="number" class="px-6 py-4 border rounded-lg focus:outline-none" x-model="quantity">
                </div>
                <input type="number" class="hidden" x-model="item_id">
                <button class="bg-primary-500 text-white px-4 py-2 rounded-lg hover:bg-primary-400 focus:outline-none"
                    @click="addToCart()">Add to Cart</button>
            </div>
        </div>
    </div>
</main>
{% endblock content %}

{% block scripts %}
<script>
    document.addEventListener('alpine:init', () => {
        Alpine.store('cart', {
            item_id: Number('{{ product.pk }}'),
            quantity: 1,
            csrf() {
                const field = document.getElementById('token')?.firstElementChild
                return field.value;
            },
            async addToCart() {

                const obj = { product_id: this.item_id, quantity: this.quantity }

                const response = await fetch("{% url 'cart:add-to-cart' %}", {
                    method: 'POST',
                    headers: {
                        Accept: 'application/json',
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.csrf(),
                    },
                    body: JSON.stringify(obj),
                })
                const data = await response.json()
                console.log(data)
                window.location.href = '/cart/checkout/'
            }
        });
    })

</script>
{% endblock %}